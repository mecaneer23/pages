<!DOCTYPE html>
<html lang="en">

<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Pages</title>
    <style>
        form {
            margin-top: 20vh;
        }

        label {
            padding-bottom: 0.5vh;
            display: block;
            font-size: x-large;
        }
    </style>
    <link rel="stylesheet" href="style.css">
</head>

<body>
    <a href="https://github.com/mecaneer23/pages" class="github-corner" aria-label="View source on GitHub"><svg
            viewBox="0 0 250 250" aria-hidden="true">
            <path d="M0,0 L115,115 L130,115 L142,142 L250,250 L250,0 Z"></path>
            <path
                d="M128.3,109.0 C113.8,99.7 119.0,89.6 119.0,89.6 C122.0,82.7 120.5,78.6 120.5,78.6 C119.2,72.0 123.4,76.3 123.4,76.3 C127.3,80.9 125.5,87.3 125.5,87.3 C122.9,97.6 130.6,101.9 134.4,103.2"
                fill="currentColor" style="transform-origin: 130px 106px" class="octo-arm"></path>
            <path
                d="M115.0,115.0 C114.9,115.1 118.7,116.5 119.8,115.4 L133.7,101.6 C136.9,99.2 139.9,98.4 142.2,98.6 C133.8,88.0 127.5,74.4 143.8,58.0 C148.5,53.4 154.0,51.2 159.7,51.0 C160.3,49.4 163.2,43.6 171.4,40.1 C171.4,40.1 176.1,42.5 178.8,56.2 C183.1,58.6 187.2,61.8 190.9,65.4 C194.5,69.0 197.7,73.2 200.1,77.6 C213.8,80.2 216.3,84.9 216.3,84.9 C212.7,93.1 206.9,96.0 205.4,96.6 C205.1,102.4 203.0,107.8 198.3,112.5 C181.9,128.9 168.3,122.5 157.7,114.1 C157.9,116.9 156.7,120.9 152.7,124.9 L141.0,136.5 C139.8,137.7 141.6,141.9 141.8,141.8 Z"
                fill="currentColor" class="octo-body"></path>
        </svg>
    </a>
    <form action="javascript:run();">
        <label for="url">Enter GitHub folder link:</label><br>
        <input type="text" placeholder="https://github.com/mecaneer23/pages/" id="url" autofocus>
        <input class="button" type="submit" value="Submit">
    </form>
    <script>
        function errorIf(condition, message) {
            if (condition) {
                alert(message);
                throw Error(message);
            }
        }

        function parseUrl(url) {
            errorIf(
                !url.startsWith("https://github.com/"),
                "Invalid url: must be full github url"
            );
            const [user, repo, _, possibleBranch, ...rest] = url.replace("https://github.com/", "").split("/");
            const path = rest.join("/");
            const branch = possibleBranch ? `?ref=${possibleBranch}` : "";
            errorIf(!repo, `Repo "${repo}" not found`);
            return {
                user: user,
                repo: repo,
                path: path,
                branch: branch,
            };
        }

        function folderLinkToList() {
            const folderLink = document.getElementById("url").value;
            const url = parseUrl(folderLink);
            const fetchUrl = `https://api.github.com/repos/${url.user}/${url.repo}/contents/${url.path}${url.branch}`;
            return fetch(fetchUrl).then((response) => {
                errorIf(!response.ok, `Invalid repository "${url.repo}"`);
                return response.json();
            });
        }

        function createFrame() {
            const frame = document.createElement("iframe");
            frame.style.width = "100vw";
            frame.style.height = "100vh";
            frame.style.position = "absolute";
            frame.style.top = "0";
            frame.style.left = "0";
            frame.frameBorder = "0";
            document.body.appendChild(frame);
            return frame;
        }

        function getIndexFile(files) {
            for (file of files) {
                if (file.name === "index.html" && file.type === "file") {
                    return file.download_url;
                }
            }
            return null;
        }

        function formatRawMaterial(material, tagType) {
            return `<${tagType}>${material}</${tagType}>`;
        }

        async function fetchFile(path, files) {
            for (file of files) {
                if (file.name === path && file.type === "file") {
                    return await fetch(file.download_url).then(async (response) => await response.text());
                }
                // TODO: implement using paths which include folders
            }
            errorIf(true, "File not found in files list");
        }

        async function handleImports(indexHtml, files) {
            let formattedHTML = "";
            let title = "Pages"
            const htmlElement = document.createElement("div");
            for (let line of indexHtml.split("\n")) {
                if (line.length == 0 || !line.match(/<((link)|(script)|(title))/)) {
                    formattedHTML += `${line}\n`;
                    continue;
                }
                htmlElement.innerHTML = line.trim();
                let type = htmlElement.firstChild.nodeName.toLowerCase();
                let attributes = htmlElement.firstChild.attributes;
                if (type === "link" && attributes.rel.value === "stylesheet") {
                    formattedHTML += formatRawMaterial(await fetchFile(attributes.href.value, files), "style");
                    continue;
                }
                if (type === "script" && "src" in attributes) {
                    formattedHTML += formatRawMaterial(await fetchFile(attributes.src.value, files), "script");
                    continue;
                }
                if (type === "title") {
                    title = htmlElement.firstChild.innerHTML;
                }
                formattedHTML += `${line}\n`;
            }
            return {
                html: formattedHTML,
                title: title,
            };
        }

        async function run() {
            const files = await folderLinkToList();
            const rawUrl = getIndexFile(files);
            errorIf(!rawUrl, "No `index.html` found in entered folder");
            const frame = createFrame();
            fetch(rawUrl).then(async (response) => {
                const formattedHTML = await handleImports(await response.text(), files);
                const text = formattedHTML.html;
                if (!text) {
                    return;
                }
                const doc = frame.contentWindow.document;
                doc.open();
                doc.write(text);
                doc.close();
                document.querySelector("form").style.display = "none";
                document.body.style.all = "initial";
                document.querySelector(".github-corner").style.display = "none";
                document.title = formattedHTML.title;
            });
        }
    </script>
</body>

</html>